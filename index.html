<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Martial Peak ‚Äî Reader</title>

  <!-- Markdown renderer -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    /* THEME TOKENS */
    :root[data-theme="light"] {
      --bg: #fff;
      --fg: #111;
      --muted: #666;
      --primary: #3b82f6;
      --surface: #f6f6f6;
      --border: #e5e7eb;
      --link: #1d4ed8;
    }
    :root[data-theme="dark"] {
      --bg: #0b0b0c;
      --fg: #eee;
      --muted: #a1a1aa;
      --primary: #60a5fa;
      --surface: #16161a;
      --border: #232329;
      --link: #93c5fd;
    }
    
    :root { --header-h: 56px; }     /* adjust if you like */
    header.site-header { min-height: var(--header-h); }

    :root{
    --content-w: 72ch; /* default comfortable width ~ 70‚Äì75 characters */
    }

    


    /* LAYOUT */
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background: var(--bg);
      color: var(--fg);
      font: 16px/1.6 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }

    /* global hidden helper (keeps layout space like your .nav rule) */
    .hidden { visibility: hidden; }


    .app {
      display: grid;
      grid-template-columns: 280px 1fr;
      height: 100vh;
      transition: grid-template-columns .2s ease;
    }
    /* desktop collapse state */
    body.sidebar-collapsed .app { grid-template-columns: 0 1fr; }
    /* you already have: body.sidebar-collapsed .app { grid-template-columns: 0 1fr; } */
    body.sidebar-collapsed .sidebar {
      width: 0 !important;
      padding: 0 !important;
      margin: 0 !important;
      border: 0 !important;
      overflow: hidden !important;
    }
    body.sidebar-collapsed .sidebar * { display: none !important; } /* hide children so nothing paints */


    /* SIDEBAR */
    .sidebar {
      background: var(--surface);
      border-right: 1px solid var(--border);
      padding: 12px;
      overflow-y: auto;
      position: relative;
      z-index: 1001; /* above the overlay */
    }

    .sidebar h1{
    text-align:center;
    margin: 6px 0 10px;
    font-size: 18px;
    font-weight: 700;
    }

    .chapter-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .chapter-list a {
      display: block;
      padding: 8px 10px;
      border-radius: 8px;
      color: var(--fg);
      text-decoration: none;
      border: 1px solid transparent;
    }
    .chapter-list a:hover {
      background: rgba(127,127,127,.08);
      border-color: var(--border);
    }
    .chapter-list a.active {
      background: rgba(99,102,241,0.12);
      border-color: var(--primary);
      color: var(--primary);
      font-weight: 600;
    }

    /* keep the layout inside the viewport on every device */
    html, body { overflow-x: hidden; }

    /* prevent long titles from stretching the header */
    #chapterTitle {
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* keep chapter content within the screen */
    article#article {
      max-width: 100%;
      overflow-wrap: anywhere;   /* handles super-long words/links */
      word-break: break-word;
    }

    /* make wide content responsive */
    article#article img,
    article#article table,
    article#article iframe {
      max-width: 100%;
      height: auto;
    }


    /* CONTENT */
    /* Let the whole right column scroll so the scrollbar is at the viewport edge */
    /* Right column no longer scrolls itself */
    .content {
      display: flex;
      flex-direction: column;
      min-width: 0;
      min-height: 0;
      overflow: hidden;                 /* ‚Üê was auto */
    }

        /* New: inner scroller so the track sits at far right,
      and does NOT run behind the sticky header */
    .scroller {
      flex: 1 1 auto;
      min-height: 0;
      overflow: auto;
      scrollbar-gutter: stable;         /* keeps a gutter so layout doesn‚Äôt jump */
      scroll-padding-top: var(--header-h);  /* anchors don‚Äôt hide under header */
    }

    header.site-header {
      position: sticky;
      top: 0;
      z-index: 1002;
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 14px;
      height: var(--header-h);     /* ‚Üê explicit height */
      background: var(--surface);
      border-bottom: 1px solid var(--border);
    }

    /* BUTTONS (theme + arrows share the same style) */
    /* shared style for theme + arrow buttons */
    .icon-btn {
      background: none;
      border: 1px solid var(--border);
      border-radius: 10px;
      width: 42px;
      height: 42px;             /* was 38px */
      display: inline-grid;
      place-items: center;
      cursor: pointer;
      color: var(--fg);
      text-decoration: none;
      font-size: 20px;          /* force same glyph size */
      line-height: 1;
      padding: 0;
    }

    @media (max-width: 900px) {
      .icon-btn {
        width: 44px;
        height: 44px;
        font-size: 22px;        /* slightly larger + crisper on phones */
      }
    }

    .icon-btn svg {
      width: 20px;
      height: 20px;
      display: block;
    }

    @media (max-width: 900px) {
      .icon-btn svg { width: 22px; height: 22px; }
    }


    .icon-btn:hover { filter: brightness(1.05); }

    /* HAMBURGER */
    .menu {
      background: none;
      border: none;
      display: inline-flex;
      flex-direction: column;
      gap: 4px;
      padding: 8px;
      cursor: pointer;
    }
    .menu span {
      width: 24px;
      height: 2.5px;
      background: var(--fg);
      border-radius: 2px;
      transition: background .2s ease;
    }

    .tools {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    main.reader {
      flex: 0 0 auto;
      overflow: visible;
      box-sizing: border-box;
      max-width: 72ch;                  /* your readable width */
      margin: 0 auto;
      padding: 8px 16px 40px;           /* small top pad so text doesn‚Äôt kiss border */
    }
    @media (min-width: 901px){
      main.reader{ padding: 0 24px 56px; }
    }


    .nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin: 10px 0 18px;
    }

    article#article { font-size: 1.05rem; }
    article#article h1, article#article h2, article#article h3 {
      line-height: 1.25;
      margin-top: 1.4em;
    }
    article#article p { margin: 1em 0; }
    article#article hr {
      border: 0;
      border-top: 1px solid var(--border);
      margin: 2rem 0;
    }
    article#article a { color: var(--link); }

    /* OVERLAY for mobile only */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.45);
      display: none;
      z-index: 1000; /* below sidebar (1001) */
    }
    .overlay.show { display: block; }

    /* MOBILE */
    @media (max-width: 900px) {
      .app { grid-template-columns: 1fr; }          /* sidebar column hidden */

      .sidebar{
        position: fixed;
        left: 0; top: 0; bottom: 0;
        transform: translateX(-100%);
        transition: transform .25s ease;
        width: min(85vw, 320px);
        z-index: 1100;                               /* above page header */
        background: var(--surface);
        border-right: 1px solid var(--border);
        overflow-y: auto;                             /* drawer scrolls */
        padding-top: calc(env(safe-area-inset-top, 0px) + 12px);  /* space from top */
      }
      .sidebar.open{ transform: translateX(0); }

      /* Simple title ‚Äî centered, no sticky */
      .sidebar h1{
        margin: 0 0 12px;
        padding: 0 16px;
        text-align: center;
        font-size: 18px;
        font-weight: 700;
      }

      /* List sits right under the title */
      .sidebar ul{
        margin: 0;
        padding: 0;
      }

      /* overlay sits below drawer but above content */
      .overlay{ z-index: 1090; }
    }


  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar" id="sidebar">
      <h1>Martial Peak</h1>
      <ul class="chapter-list" id="chaptersList"></ul>
    </aside>

    <div class="content">
      <header class="site-header">
        <button class="menu" id="menuBtn" aria-label="Menu">
          <span></span><span></span><span></span>
        </button>
        <strong id="chapterTitle">Loading‚Ä¶</strong>
        <div class="tools">
          <button id="themeBtn" class="icon-btn" title="Toggle theme">üåì</button>
          <!-- top nav arrows -->
          <a href="#" id="prevTop" class="icon-btn hidden" aria-label="Previous">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
              stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
          </a>
          <a href="#" id="nextTop" class="icon-btn hidden" aria-label="Next">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
              stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
          </a>
        </div>
      </header>

      <div class="scroller">
        <main class="reader">
          <nav class="nav" id="topNav" style="display:none;"></nav> <!-- kept for structure -->
          <article id="article"></article>
          <nav class="nav" id="bottomNav">
            <a href="#" id="prevBottom" class="icon-btn hidden" aria-label="Previous">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <polyline points="15 18 9 12 15 6"></polyline>
              </svg>
            </a>
            <a href="#" id="nextBottom" class="icon-btn hidden" aria-label="Next">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <polyline points="9 18 15 12 9 6"></polyline>
              </svg>
            </a>
          </nav>
        </main>
      </div>
    </div>
  </div>

  <div class="overlay" id="overlay"></div>

  <script>
    // --- Theme ---
    const themeBtn = document.getElementById('themeBtn');
    function setTheme(mode) {
      document.documentElement.setAttribute('data-theme', mode);
      localStorage.setItem('mp_theme', mode);
      themeBtn.textContent = (mode === 'dark') ? '‚òÄÔ∏è' : 'üåô';
    }
    setTheme(localStorage.getItem('mp_theme') || 'light');
    themeBtn.addEventListener('click', () => {
      setTheme((localStorage.getItem('mp_theme') || 'light') === 'light' ? 'dark' : 'light');
    });

    // --- Sidebar open/close ---
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('overlay');
    const menuBtn = document.getElementById('menuBtn');
    const isMobile = () => window.matchMedia('(max-width: 900px)').matches;

    function openSidebarMobile(){ sidebar.classList.add('open'); overlay.classList.add('show'); }
    function closeSidebarMobile(){ sidebar.classList.remove('open'); overlay.classList.remove('show'); }

    menuBtn.addEventListener('click', () => {
      if (isMobile()) {
        // mobile: slide drawer with overlay
        sidebar.classList.contains('open') ? closeSidebarMobile() : openSidebarMobile();
      } else {
        // desktop: collapse/expand sidebar; NEVER show overlay on desktop
        document.body.classList.toggle('sidebar-collapsed');
        overlay.classList.remove('show');
      }
    });
    overlay.addEventListener('click', closeSidebarMobile);
    window.addEventListener('resize', () => { if (!isMobile()) overlay.classList.remove('show'); });

    // --- Helpers ---
    const qs = (sel) => document.querySelector(sel);
    const titleEl = qs('#chapterTitle');
    const chaptersListEl = qs('#chaptersList');
    const articleEl = qs('#article');
    const scrollerEl = document.querySelector('.scroller');


    const navEls = {
      prevTop: qs('#prevTop'),
      nextTop: qs('#nextTop'),
      prevBottom: qs('#prevBottom'),
      nextBottom: qs('#nextBottom'),
    };

    function getParam(name) {
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }
    function setParam(name, value) {
      const url = new URL(window.location.href);
      if (value == null) url.searchParams.delete(name);
      else url.searchParams.set(name, value);
      history.pushState({}, '', url);
    }
    function normalizeId(id) {
      if (!id) return id;
      return id.endsWith('.md') ? id.slice(0, -3) : id;
    }

    // --- Load chapters index ---
    let CHAPTERS = [];        // [{ id, title }]
    let currentIndex = -1;    // index in CHAPTERS

    async function loadIndex() {
      try {
        const res = await fetch('chapters/chapters.json', { cache: 'no-cache' });
        CHAPTERS = await res.json();
      } catch (e) {
        console.error('Failed to load chapters.json', e);
        CHAPTERS = [];
      }
      renderList();
    }

    function renderList() {
      chaptersListEl.innerHTML = '';
      CHAPTERS.forEach((c, i) => {
        const li = document.createElement('li');
        const a = document.createElement('a');
        a.href = `?chapter=${encodeURIComponent(c.id)}`;
        a.textContent = c.title || c.id;
        a.addEventListener('click', (ev) => {
          ev.preventDefault();
          openChapterByIndex(i);
          if (isMobile()) closeSidebarMobile();
        });
        li.appendChild(a);
        chaptersListEl.appendChild(li);
      });
    }

    function highlightActive() {
      const links = chaptersListEl.querySelectorAll('a');
      links.forEach((a, i) => {
        a.classList.toggle('active', i === currentIndex);
      });
    }

    async function openChapterById(id) {
      const norm = normalizeId(id);
      const index = CHAPTERS.findIndex(c => c.id === norm);
      if (index === -1 && CHAPTERS.length > 0) return openChapterByIndex(0);
      return openChapterByIndex(index);
    }

    async function openChapterByIndex(i) {
      if (i < 0 || i >= CHAPTERS.length) return;
      currentIndex = i;
      const { id, title } = CHAPTERS[i];
      titleEl.textContent = title || id;
      document.title = (title || id) + ' ‚Äî Martial Peak Reader';

      // prev/next (top & bottom)
      updateNav(navEls.prevTop, i - 1);
      updateNav(navEls.nextTop, i + 1);
      updateNav(navEls.prevBottom, i - 1);
      updateNav(navEls.nextBottom, i + 1);

      setParam('chapter', id);
      highlightActive();

      try {
        const res = await fetch(`chapters/${id}.md`, { cache: 'no-cache' });
        if (!res.ok) throw new Error(res.status + ' ' + res.statusText);
        const md = await res.text();
        articleEl.innerHTML = marked.parse(md);
        if (scrollerEl) scrollerEl.scrollTo({ top: 0, behavior: 'auto' }); // or 'smooth'
      } catch (e) {
        console.error('Failed to load chapter', id, e);
        articleEl.innerHTML = ''; // silent fail
      }
    }

    function updateNav(anchor, idx) {
      if (idx >= 0 && idx < CHAPTERS.length) {
        anchor.classList.remove('hidden');
        anchor.href = `?chapter=${CHAPTERS[idx].id}`;
        anchor.onclick = (ev) => { ev.preventDefault(); openChapterByIndex(idx); };
      } else {
        anchor.classList.add('hidden');
        anchor.removeAttribute('href');
        anchor.onclick = null;
      }
    }

    // initial load
    (async function init() {
      await loadIndex();
      const q = getParam('chapter');
      if (q) openChapterById(q);
      else if (CHAPTERS.length > 0) openChapterByIndex(0);
    })();

    // handle browser back/forward
    window.addEventListener('popstate', () => {
      const q = getParam('chapter');
      if (q) openChapterById(q);
    });
  </script>
</body>
</html>
