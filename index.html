<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Martial Peak ‚Äî Chapters</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    :root{--bg:#0b0b0c;--fg:#e9e9ea;--muted:#a4a4a8;--card:#151518;--accent:#7aa2f7;--border:#2a2a2d}
    @media (prefers-color-scheme: light){
      :root{--bg:#ffffff;--fg:#111416;--muted:#5a5f66;--card:#f4f5f7;--accent:#2b5cff;--border:#e5e7eb}
    }
    *{box-sizing:border-box}
    html,body{margin:0;overflow-x:hidden;background:var(--bg);color:var(--fg);font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Inter,"Noto Sans",sans-serif}
    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline}

    /* Layout */
    .app{display:grid;grid-template-columns:280px 1fr;min-height:100svh}
    .sidebar{background:var(--card);border-right:1px solid var(--border);display:flex;flex-direction:column;z-index:1001}
    .brand{padding:16px 16px 8px;font-weight:700}
    .tools{padding:8px 16px;display:flex;gap:8px}
    .tools input{flex:1;padding:8px;border:1px solid var(--border);background:transparent;color:var(--fg);border-radius:8px}
    .tools button{padding:8px 10px;border:1px solid var(--border);background:transparent;color:var(--fg);border-radius:10px;cursor:pointer}
    .chapters{overflow:auto;padding:8px}
    .chapters a{display:block;padding:8px 12px;border-radius:8px;color:var(--fg)}
    .chapters a.active{background:rgba(127,127,127,.15)}

    .content{display:flex;flex-direction:column;min-width:0}
    header{position:sticky;top:0;z-index:1002;background:var(--bg);border-bottom:1px solid var(--border);padding:12px 16px;display:flex;gap:12px;align-items:center;justify-content:space-between}

    /* header buttons */
    .btn{display:inline-grid;place-items:center;width:42px;height:38px;border:1px solid var(--border);background:var(--card);color:var(--fg);border-radius:10px;cursor:pointer;text-decoration:none;font-size:18px;font-weight:600}
    .btn:hover{filter:brightness(1.05)}
    .group{display:flex;gap:8px;align-items:center}

    main{padding:24px;max-width:900px;margin:0 auto;width:100%}
    .article h1,.article h2,.article h3{line-height:1.25}
    .article p{margin:1em 0}
    .article img{max-width:100%;height:auto}
    .article blockquote{margin:1em 0;padding:0 1em;border-left:3px solid #3a3a3f;color:var(--muted)}
    .article code{background:#1c1c21;padding:.15em .4em;border-radius:6px}
    .article pre{overflow:auto;padding:12px;border-radius:10px;background:#1c1c21}

    /* Top & bottom nav */
    .nav{display:flex;justify-content:space-between;gap:12px;margin:18px 0}

    /* Overlay under sidebar */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);backdrop-filter:blur(2px);z-index:1000}

    /* Mobile: off-canvas sidebar */
    @media (max-width:900px){
      .app{grid-template-columns:1fr}
      .sidebar{position:fixed;inset:0 28% 0 0;transform:translateX(-100%);transition:transform .22s ease}
      .sidebar.open{transform:none}
    }

    /* Desktop: allow collapsing sidebar with hamburger; no overlay */
    @media (min-width:901px){
      body.sidebar-collapsed .app{grid-template-columns:0 1fr}
      body.sidebar-collapsed .sidebar{width:0;border:0;overflow:hidden}
      .overlay{display:none}
    }
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar" id="sidebar">
      <div class="brand">Martial Peak</div>
      <div class="tools">
        <input id="filter" type="search" placeholder="Filter chapters‚Ä¶" aria-label="Filter chapters" />
        <button id="themeBtn" class="btn" title="Toggle theme">üåì</button>
      </div>
      <nav class="chapters" id="chaptersList" aria-label="Chapters"></nav>
    </aside>

    <div class="content">
      <header>
        <div class="group">
          <button class="btn" id="menuBtn" aria-label="Toggle menu">‚ò∞</button>
          <strong id="title">Loading‚Ä¶</strong>
        </div>
        <div class="group">
          <!-- top nav arrows -->
          <a href="#" id="prevTop" class="btn" aria-label="Previous" title="Previous">‚Üê</a>
          <a href="#" id="nextTop" class="btn" aria-label="Next" title="Next">‚Üí</a>
        </div>
      </header>

      <main>
        <article id="article" class="article"></article>
        <nav class="nav">
          <a href="#" id="prevBtn" class="btn" aria-label="Previous" title="Previous">‚Üê</a>
          <a href="#" id="nextBtn" class="btn" aria-label="Next" title="Next">‚Üí</a>
        </nav>
      </main>
    </div>
  </div>
  <div class="overlay hidden" id="overlay" style="display:none"></div>

  <script>
    const qs = (s, el=document) => el.querySelector(s);
    const qsa = (s, el=document) => [...el.querySelectorAll(s)];
    const getParam = (key) => new URLSearchParams(location.search).get(key);
    const setParam = (key, val) => {
      const u = new URL(location);
      if (val) u.searchParams.set(key, val); else u.searchParams.delete(key);
      history.pushState({}, "", u);
    };
    const normalizeId = (v) => v && v.trim().endsWith(".md") ? v.trim().slice(0,-3) : v;

    /* THEME */
    const themeKey = "mp_theme";
    const setTheme = (t) => {
      document.documentElement.dataset.theme = t;
      localStorage.setItem(themeKey, t);
      document.body.style.backgroundColor =
        getComputedStyle(document.documentElement).getPropertyValue('--bg');
    };
    const toggleTheme = () => setTheme((localStorage.getItem(themeKey)==="light") ? "dark" : "light");
    setTheme(localStorage.getItem(themeKey) || (matchMedia("(prefers-color-scheme: light)").matches ? "light" : "dark"));
    qs('#themeBtn').onclick = toggleTheme;

    /* STATE */
    let CHAPTERS = [];
    let currentIndex = -1;

    const article   = qs('#article');
    const list      = qs('#chaptersList');
    const titleEl   = qs('#title');
    const filterInp = qs('#filter');
    const sidebar   = qs('#sidebar');
    const overlay   = qs('#overlay');

    /* Sidebar behavior */
    const isMobile = () => matchMedia("(max-width: 900px)").matches;
    function openSidebarMobile(){ sidebar.classList.add('open'); overlay.style.display='block'; }
    function closeSidebarMobile(){ sidebar.classList.remove('open'); overlay.style.display='none'; }
    qs('#menuBtn').onclick = () => {
      if (isMobile()){
        sidebar.classList.contains('open') ? closeSidebarMobile() : openSidebarMobile();
      } else {
        document.body.classList.toggle('sidebar-collapsed');
      }
    };
    overlay.onclick = closeSidebarMobile;
    addEventListener('resize', () => { if (!isMobile()) overlay.style.display='none'; });

    /* Load index & render list */
    async function loadIndex(){
      try{
        const res = await fetch('chapters/chapters.json', { cache: 'no-store' });
        CHAPTERS = await res.json();
        renderList();
      }catch(e){
        article.innerHTML = `<p>Could not load chapters index. Ensure <code>chapters/chapters.json</code> exists.</p>`;
        console.error(e);
      }
    }

    function renderList(){
      list.innerHTML = "";
      CHAPTERS.forEach(c=>{
        const a = document.createElement('a');
        a.href = `?chapter=${c.id}`;
        a.dataset.id = c.id;
        a.textContent = c.title || c.id;
        a.onclick = (ev)=>{ ev.preventDefault(); loadChapter(c.id); if (isMobile()) closeSidebarMobile(); };
        list.appendChild(a);
      });
      applyFilter(filterInp.value);
      const id = normalizeId(getParam('chapter')) || (CHAPTERS[0] && CHAPTERS[0].id);
      if (id) loadChapter(id);
    }

    function applyFilter(q){
      q = (q||"").toLowerCase().trim();
      qsa('a', list).forEach(a=>{
        const m = a.textContent.toLowerCase().includes(q) || a.dataset.id.toLowerCase().includes(q);
        a.style.display = m ? "" : "none";
      });
    }
    filterInp.addEventListener('input', e=>applyFilter(e.target.value));

    /* Load chapter */
    async function loadChapter(id){
      id = normalizeId(id); if (!id) return;
      setParam('chapter', id);
      currentIndex = CHAPTERS.findIndex(c=>c.id===id);
      qsa('a', list).forEach(a=>a.classList.toggle('active', a.dataset.id===id));

      const meta = CHAPTERS[currentIndex] || { id };
      titleEl.textContent = meta.title || id;
      article.innerHTML = "";

      try{
        const res = await fetch(`chapters/${id}.md`, { cache: 'no-store' });
        if (!res.ok) throw new Error(`Missing file: chapters/${id}.md`);
        const md = await res.text();
        article.innerHTML = marked.parse(md, { mangle:false, headerIds:true });
        document.title = `${meta.title || id} ‚Äî Martial Peak`;
      }catch(e){
        article.innerHTML = `<p>Chapter not found: <code>chapters/${id}.md</code></p>`;
        console.error(e);
      }

      // update nav buttons (top & bottom)
      updateNav('#prevTop', currentIndex-1);
      updateNav('#nextTop', currentIndex+1);
      updateNav('#prevBtn', currentIndex-1);
      updateNav('#nextBtn', currentIndex+1);

      scrollTo({ top:0, behavior:'instant' });
    }

    function updateNav(sel, idx){
      const el = qs(sel);
      if (idx>=0 && idx<CHAPTERS.length){
        el.style.visibility = '';
        el.href = `?chapter=${CHAPTERS[idx].id}`;
        el.onclick = (ev)=>{ ev.preventDefault(); loadChapter(CHAPTERS[idx].id); };
      }else{
        el.style.visibility = 'hidden';
        el.removeAttribute('href');
        el.onclick = null;
      }
    }

    /* keyboard */
    addEventListener('keydown', (e)=>{
      if ((e.key==='k'||e.key==='ArrowLeft') && currentIndex>0) loadChapter(CHAPTERS[currentIndex-1].id);
      else if ((e.key==='j'||e.key==='ArrowRight') && currentIndex<CHAPTERS.length-1) loadChapter(CHAPTERS[currentIndex+1].id);
      else if (e.key==='/' && document.activeElement!==filterInp){ e.preventDefault(); filterInp.focus(); }
    });

    /* History navigation */
    addEventListener('popstate', ()=>{
      const id = normalizeId(getParam('chapter')) || (CHAPTERS[0] && CHAPTERS[0].id);
      if (id) loadChapter(id);
    });

    loadIndex();
  </script>
</body>
</html>
